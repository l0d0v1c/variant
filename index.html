<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genome Explorer - Recherche de Variants Génétiques</title>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Pako (gzip decompression) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            --dark: #2c3e50;
            --light: #ecf0f1;
            --glass: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 226, 0.3) 0%, transparent 50%);
            animation: backgroundFlow 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundFlow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 1s ease;
        }

        .header h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .header .subtitle {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
            margin-bottom: 20px;
        }

        /* Glass morphism card */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            animation: fadeInUp 1s ease 0.2s both;
        }

        .stat-card {
            padding: 30px;
            text-align: center;
            color: white;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Search Section */
        .search-section {
            margin-bottom: 40px;
            animation: fadeInUp 1s ease 0.4s both;
        }

        .search-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
        }

        .search-tab {
            flex: 1;
            padding: 15px 25px;
            border: none;
            background: transparent;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .search-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .search-tab:hover::before {
            left: 100%;
        }

        .search-tab.active {
            background: rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .search-form {
            padding: 40px;
            display: none;
        }

        .search-form.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: white;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .form-control:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.15);
        }

        .form-control::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .search-btn {
            background: var(--accent);
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .search-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .search-btn:hover::before {
            left: 100%;
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .search-btn.loading {
            pointer-events: none;
        }

        .search-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeInUp 1s ease;
        }

        .results-header {
            padding: 30px 40px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .results-count {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .results-actions {
            display: flex;
            gap: 10px;
        }

        .btn-secondary {
            padding: 10px 20px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .results-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 0 20px;
        }

        .results-container::-webkit-scrollbar {
            width: 8px;
        }

        .results-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .results-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .results-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .result-item {
            background: rgba(255,255,255,0.05);
            margin: 20px 0;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .result-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent);
        }

        .result-item:hover {
            transform: translateX(10px);
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .result-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .result-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-rsid {
            background: var(--success);
            color: white;
        }

        .badge-position {
            background: var(--secondary);
            color: white;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .detail-label {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .mutation-display {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 10px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-weight: 600;
        }

        .mutation-complex {
            background: rgba(255, 152, 0, 0.2);
            border-color: rgba(255, 152, 0, 0.3);
        }

        /* ClinVar Button and Display */
        .clinvar-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .clinvar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .clinvar-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .clinvar-btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 0;
            bottom: 0;
            right: 10px;
        }

        .clinvar-result {
            margin-top: 15px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }

        .clinvar-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: white;
        }

        .clinvar-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .clinvar-mutation {
            background: rgba(76, 175, 80, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-weight: bold;
            margin-left: 10px;
            font-size: 0.9rem;
        }

        .clinvar-conditions {
            /* Pas de limitation de hauteur ni de scroll */
        }

        .clinvar-condition {
            background: rgba(255,255,255,0.08);
            margin: 8px 0;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            color: white;
            font-size: 0.95rem;
        }

        .clinvar-condition:hover {
            background: rgba(255,255,255,0.12);
        }

        .clinvar-error {
            color: #ff6b6b;
            font-style: italic;
            padding: 15px;
            text-align: center;
        }

        .clinvar-empty {
            color: rgba(255,255,255,0.7);
            font-style: italic;
            padding: 15px;
            text-align: center;
        }

        /* Loading and Empty States */
        .loading-state, .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .empty-icon {
            font-size: 4rem;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .search-tabs {
                flex-direction: column;
                gap: 5px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .search-form {
                padding: 30px 20px;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                text-align: center;
            }

            .result-details {
                grid-template-columns: 1fr;
            }

            .result-item:hover {
                transform: none;
            }

            .header h1 {
                font-size: 2.5rem;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .glass-card {
                background: rgba(0,0,0,0.8);
                border: 2px solid white;
            }
            
            .form-control {
                background: rgba(0,0,0,0.8);
                border: 2px solid white;
            }
        }

        /* Password Modal */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .password-modal {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 50px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.7);
            animation: modalSlideIn 0.5s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .password-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .password-input {
            width: 100%;
            padding: 20px 24px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.2rem;
            transition: var(--transition);
            backdrop-filter: blur(5px);
            margin-bottom: 25px;
            text-align: center;
            font-weight: 500;
        }

        .password-input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.15);
        }

        .password-input::placeholder {
            color: rgba(255,255,255,0.6);
            text-align: center;
        }

        .password-unlock-btn {
            background: var(--accent);
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .password-unlock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .password-unlock-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .password-unlock-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
        }

        .password-error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #f44336;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            animation: errorShake 0.5s ease;
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Loading Progress Bar */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-modal {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .loading-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            height: 30px;
            margin-bottom: 20px;
            position: relative;
        }

        .progress-bar {
            background: var(--accent);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .progress-text {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 30px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .loading-stats {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin-top: 15px;
        }

        .loading-stats strong {
            color: white;
            font-weight: 600;
        }

        /* Disease Search Results */
        .disease-result {
            background: rgba(255,255,255,0.05);
            margin: 15px 0;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 4px solid var(--accent);
        }

        .disease-result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .disease-rsid {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .disease-mutation {
            background: rgba(76, 175, 80, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-weight: 600;
            color: white;
        }

        .disease-status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-present {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .status-absent {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .disease-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .disease-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--success);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: var(--transition);
        }

        .disease-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .disease-summary {
            background: rgba(255,255,255,0.08);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
        }

        .disease-summary h3 {
            margin: 0 0 15px 0;
            color: white;
        }

        /* Mutation Comparison */
        .mutation-match {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }

        .mutation-match.match {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
            border: 2px solid #4caf50;
        }

        .mutation-match.no-match {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 2px solid #ff9800;
        }
    </style>
</head>
<body>
    <!-- Password Modal -->
    <div class="password-overlay" id="password-overlay">
        <div class="password-modal">
            <div class="password-title">
                <i class="fas fa-lock"></i>
                Déverrouiller le Génome
            </div>
            <form id="password-form">
                <input type="password" 
                       id="password-input" 
                       class="password-input" 
                       placeholder="Entrez le mot de passe..."
                       autocomplete="current-password"
                       autocorrect="off"
                       autocapitalize="off"
                       spellcheck="false"
                       required>
                <button type="submit" class="password-unlock-btn" id="unlock-btn">
                    <i class="fas fa-unlock"></i> Déverrouiller
                </button>
                <div class="password-error" id="password-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    Mot de passe incorrect. Veuillez réessayer.
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Progress Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-modal">
            <div class="loading-title">
                <i class="fas fa-dna"></i> Chargement du Génome
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar">
                    <span class="progress-text" id="progress-text">0%</span>
                </div>
            </div>
            <div class="loading-stats">
                <div id="loading-message">Initialisation...</div>
                <div id="loading-details" style="margin-top: 10px;">
                    <strong id="variants-processed">0</strong> / <strong id="variants-total">4,427,116</strong> variants traités
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-dna"></i> Genome Explorer</h1>
            <p class="subtitle">Explorez et recherchez dans 4.4M de variants génétiques</p>
        </header>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card glass-card">
                <div class="stat-number" id="total-variants">4,427,116</div>
                <div class="stat-label">Variants Génétiques</div>
            </div>
            <div class="stat-card glass-card">
                <div class="stat-number" id="rsid-count">0</div>
                <div class="stat-label">RS IDs</div>
            </div>
            <div class="stat-card glass-card">
                <div class="stat-number" id="position-count">0</div>
                <div class="stat-label">Positions Uniques</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section glass-card">
            <div class="search-tabs">
                <button class="search-tab active" data-tab="snp">
                    <i class="fas fa-hashtag"></i> Recherche par SNP (RS ID)
                </button>
                <button class="search-tab" data-tab="position">
                    <i class="fas fa-map-marker-alt"></i> Recherche par Position
                </button>
                <button class="search-tab" data-tab="disease">
                    <i class="fas fa-disease"></i> Recherche par Maladie
                </button>
            </div>

            <!-- SNP Search -->
            <form class="search-form active" id="snp-form">
                <div class="form-group">
                    <label for="snp-input">
                        <i class="fas fa-search"></i> Numéro RS (décimal)
                    </label>
                    <input type="number" 
                           id="snp-input" 
                           class="form-control" 
                           placeholder="Ex: 2758118, 147471088, 10399793..." 
                           min="1"
                           autocomplete="off">
                </div>
                <button type="submit" class="search-btn">
                    <i class="fas fa-dna"></i> Rechercher SNP
                </button>
            </form>

            <!-- Position Search -->
            <form class="search-form" id="position-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="chromosome-select">
                            <i class="fas fa-layer-group"></i> Chromosome
                        </label>
                        <select id="chromosome-select" class="form-control">
                            <option value="">Sélectionner...</option>
                            <option value="1">Chromosome 1</option>
                            <option value="2">Chromosome 2</option>
                            <option value="3">Chromosome 3</option>
                            <option value="4">Chromosome 4</option>
                            <option value="5">Chromosome 5</option>
                            <option value="6">Chromosome 6</option>
                            <option value="7">Chromosome 7</option>
                            <option value="8">Chromosome 8</option>
                            <option value="9">Chromosome 9</option>
                            <option value="10">Chromosome 10</option>
                            <option value="11">Chromosome 11</option>
                            <option value="12">Chromosome 12</option>
                            <option value="13">Chromosome 13</option>
                            <option value="14">Chromosome 14</option>
                            <option value="15">Chromosome 15</option>
                            <option value="16">Chromosome 16</option>
                            <option value="17">Chromosome 17</option>
                            <option value="18">Chromosome 18</option>
                            <option value="19">Chromosome 19</option>
                            <option value="20">Chromosome 20</option>
                            <option value="21">Chromosome 21</option>
                            <option value="22">Chromosome 22</option>
                            <option value="X">Chromosome X</option>
                            <option value="Y">Chromosome Y</option>
                            <option value="M">Chromosome M</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="position-input">
                            <i class="fas fa-crosshairs"></i> Position sur le chromosome
                        </label>
                        <input type="number" 
                               id="position-input" 
                               class="form-control" 
                               placeholder="Ex: 10492, 55208375, 15274..." 
                               min="1"
                               autocomplete="off">
                    </div>
                </div>
                <button type="submit" class="search-btn">
                    <i class="fas fa-location-arrow"></i> Rechercher Position
                </button>
            </form>

            <!-- Disease Search -->
            <form class="search-form" id="disease-form">
                <div class="form-group">
                    <label for="disease-input">
                        <i class="fas fa-disease"></i> Nom de la maladie ou condition
                    </label>
                    <input type="text" 
                           id="disease-input" 
                           class="form-control" 
                           placeholder="Ex: Alzheimer disease, Cancer, Diabetes..." 
                           autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="min-score-input">
                        <i class="fas fa-chart-line"></i> Score de pertinence minimum
                    </label>
                    <input type="number" 
                           id="min-score-input" 
                           class="form-control" 
                           placeholder="Score minimum (0-20)" 
                           value="10"
                           min="0" 
                           max="20"
                           step="0.1"
                           autocomplete="off">
                    <small style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-top: 5px; display: block;">
                        Plus le score est élevé, plus les résultats sont pertinents (recommandé: 10+)
                    </small>
                </div>
                <button type="submit" class="search-btn">
                    <i class="fas fa-search-plus"></i> Rechercher Maladie
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div class="results-section glass-card" id="results">
            <div class="results-header">
                <div class="results-count" id="results-count">0 résultat</div>
                <div class="results-actions">
                    <button class="btn-secondary" id="copy-btn">
                        <i class="fas fa-copy"></i> Copier Markdown
                    </button>
                    <button class="btn-secondary" id="clear-btn">
                        <i class="fas fa-times"></i> Effacer
                    </button>
                </div>
            </div>
            <div class="results-container" id="results-container">
                <!-- Results will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Genome data will be loaded and decrypted dynamically -->

    <script>
        $(document).ready(function() {
            // Application state
            const app = {
                searchIndex: {
                    rsid: new Map(),
                    position: new Map()
                },
                currentResults: [],
                isLoading: false,
                genData: null,
                isUnlocked: false,
                isUnlocking: false  // Flag anti-soumissions multiples
            };

            // Initialize password system
            initializePasswordSystem();

            async function initializePasswordSystem() {
                // Détecter iOS
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                
                // Focus on password input avec délai sur iOS pour éviter les problèmes
                if (!isIOS) {
                    $('#password-input').focus();
                } else {
                    // Sur iOS, retarder le focus pour éviter les problèmes avec le clavier virtuel
                    setTimeout(() => {
                        $('#password-input').focus();
                    }, 500);
                }
                
                // Handle password form submission
                $('#password-form').on('submit', async function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // Empêcher la propagation de l'événement
                    
                    // Vérifier si un déverrouillage est déjà en cours
                    if (app.isUnlocking) {
                        console.log('Déverrouillage déjà en cours, ignorer la soumission');
                        return false;
                    }
                    
                    const password = $('#password-input').val().trim();
                    
                    if (!password) {
                        showPasswordError('Veuillez saisir un mot de passe.');
                        return false;
                    }
                    
                    // Marquer le déverrouillage comme en cours
                    app.isUnlocking = true;
                    
                    try {
                        await attemptUnlock(password);
                    } finally {
                        // Toujours réinitialiser le flag, même en cas d'erreur
                        app.isUnlocking = false;
                    }
                    
                    return false; // Empêcher toute soumission par défaut
                });
                
                // Auto-clear error on input
                $('#password-input').on('input', function() {
                    hidePasswordError();
                });
                
                // Empêcher le double-tap sur iOS
                if (isIOS) {
                    $('#unlock-btn').on('touchend', function(e) {
                        e.preventDefault();
                        if (!app.isUnlocking) {
                            $(this).trigger('click');
                        }
                    });
                }
            }

            async function attemptUnlock(password) {
                const $unlockBtn = $('#unlock-btn');
                const $passwordInput = $('#password-input');
                
                // Vérification supplémentaire du flag
                if (app.isUnlocking) {
                    console.warn('attemptUnlock appelé alors qu\'un déverrouillage est déjà en cours');
                    return;
                }
                
                // Set loading state
                $unlockBtn.addClass('loading').prop('disabled', true);
                $unlockBtn.html('<i class="fas fa-unlock"></i> Déverrouillage...');
                $passwordInput.prop('disabled', true);
                
                try {
                    // Load and decrypt the genome file
                    const success = await loadAndDecryptGenome(password);
                    
                    if (success) {
                        // Marquer comme déverrouillé AVANT de masquer le modal
                        app.isUnlocked = true;
                        
                        // Hide password modal with animation
                        $('#password-overlay').fadeOut(500, function() {
                            $(this).remove();
                        });
                        
                        // Initialize the main application
                        initializeApp();
                    } else {
                        throw new Error('Décryptage échoué');
                    }
                    
                } catch (error) {
                    console.error('Erreur de déverrouillage:', error);
                    showPasswordError('Mot de passe incorrect ou erreur de déverrouillage.');
                    
                    // Reset form - sans focus automatique sur iOS
                    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                    $passwordInput.val('').prop('disabled', false);
                    if (!isIOS) {
                        $passwordInput.focus();
                    }
                    $unlockBtn.removeClass('loading').prop('disabled', false);
                    $unlockBtn.html('<i class="fas fa-unlock"></i> Déverrouiller');
                }
            }

            async function loadAndDecryptGenome(password) {
                try {
                    // Mode de test : essayer d'abord le fichier non crypté pour debug
                    if (password === 'TEST_DIRECT') {
                        updatePasswordProgress('Mode test : chargement direct du fichier gzip...');
                        return await loadDirectGzipFile();
                    }
                    
                    updatePasswordProgress('Téléchargement du fichier crypté...');
                    
                    // Load the encrypted file
                    const response = await fetch('gen.js.gz.secure.enc');
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    const encryptedData = await response.arrayBuffer();
                    updatePasswordProgress('Fichier téléchargé, décryptage en cours...');
                    
                    updatePasswordProgress('Utilisation du format compatible CryptoJS...');
                    
                    console.log('Taille fichier crypté:', encryptedData.byteLength);
                    
                    // Détecter le format du fichier
                    const firstByte = new Uint8Array(encryptedData)[0];
                    
                    let decryptedArray;
                    
                    if (firstByte === 0x7B) { // '{' - format JSON
                        console.log('Format JSON détecté');
                        decryptedArray = await decryptJSONFormat(encryptedData, password);
                    } else {
                        console.log('Format binaire détecté');
                        decryptedArray = await decryptBinaryFormat(encryptedData, password);
                    }
                    
                    if (!decryptedArray) {
                        throw new Error('Décryptage échoué');
                    }
                    
                    console.log('Données déchiffrées - premiers 20 bytes:', Array.from(decryptedArray.slice(0, 20)).map(b => b.toString(16).padStart(2, '0')).join(' '));
                    console.log('Vérification magic gzip:', decryptedArray[0] === 0x1f && decryptedArray[1] === 0x8b);
                    
                    updatePasswordProgress('Décompression des données...');
                    return await decompressAndParseData(decryptedArray);
                    
                } catch (error) {
                    console.error('Erreur lors du chargement:', error);
                    return false;
                }
            }

            // Fonction séparée pour tester le fichier gzip directement
            async function loadDirectGzipFile() {
                try {
                    const response = await fetch('gen.js.gz');
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    const gzipData = await response.arrayBuffer();
                    const gzipArray = new Uint8Array(gzipData);
                    
                    updatePasswordProgress('Test : décompression directe du fichier gzip...');
                    return await decompressAndParseData(gzipArray);
                    
                } catch (error) {
                    console.error('Erreur test fichier direct:', error);
                    return false;
                }
            }

            // Fonction pour décompresser et parser les données
            async function decompressAndParseData(compressedArray) {
                try {
                    console.log('Début décompression, taille données:', compressedArray.length);
                    console.log('Premiers 20 bytes:', Array.from(compressedArray.slice(0, 20)).map(b => b.toString(16).padStart(2, '0')).join(' '));
                    
                    // Vérifier si c'est du gzip (magic number 1f8b)
                    if (compressedArray.length >= 2) {
                        const isGzip = compressedArray[0] === 0x1f && compressedArray[1] === 0x8b;
                        console.log('Magic number gzip détecté:', isGzip);
                    }
                    
                    // Decompress using Pako - try different methods
                    let decompressedData;
                    try {
                        // Try gzip first
                        decompressedData = pako.ungzip(compressedArray, { to: 'string' });
                        console.log('Décompression réussie avec ungzip');
                    } catch (e) {
                        console.warn('gzip failed, trying inflate:', e.message);
                        try {
                            // Try raw inflate
                            decompressedData = pako.inflate(compressedArray, { to: 'string' });
                            console.log('Décompression réussie avec inflate');
                        } catch (e2) {
                            console.warn('inflate failed, trying inflateRaw:', e2.message);
                            // Try raw inflate without headers
                            decompressedData = pako.inflateRaw(compressedArray, { to: 'string' });
                            console.log('Décompression réussie avec inflateRaw');
                        }
                    }
                    
                    updatePasswordProgress('Analyse des données génomiques...');
                    
                    // Parse the JavaScript content
                    // The file contains JavaScript code with comments and functions
                    try {
                        console.log('Début du parsing, taille des données:', decompressedData.length);
                        
                        // Method 1: Execute the JavaScript code in isolated context
                        console.log('Exécution du code JavaScript...');
                        
                        // Create isolated function scope - the code should define 'gen' and we return it
                        const func = new Function(`
                            ${decompressedData}
                            return (typeof gen !== 'undefined') ? gen : null;
                        `);
                        
                        app.genData = func();
                        
                        // If that fails, try alternative method
                        if (!app.genData) {
                            console.log('Première méthode échouée, tentative alternative...');
                            // Try to extract just the object part (more complex regex needed)
                            const genMatch = decompressedData.match(/const\s+gen\s*=\s*({[\s\S]*?})\s*;/);
                            if (genMatch) {
                                console.log('Match trouvé avec regex alternative');
                                // This is still JavaScript object literal, not JSON, so we need eval
                                app.genData = eval('(' + genMatch[1] + ')');
                            }
                        }
                    } catch (e) {
                        console.error('Erreur de parsing:', e);
                        console.log('Début du fichier:', decompressedData.substring(0, 400));
                        console.log('Fin du fichier:', decompressedData.substring(decompressedData.length - 400));
                        throw new Error('Impossible de parser les données génomiques: ' + e.message);
                    }
                    
                    // Verify the data structure
                    if (!app.genData || !app.genData.data || !Array.isArray(app.genData.data)) {
                        throw new Error('Structure de données invalide');
                    }
                    
                    updatePasswordProgress('Génome déverrouillé avec succès!');
                    console.log(`Données chargées: ${app.genData.data.length} variants`);
                    
                    return true;
                    
                } catch (error) {
                    console.error('Erreur de décompression/parsing:', error);
                    throw error;
                }
            }

            function arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }

            function uint8ArrayToBase64(uint8Array) {
                let binary = '';
                for (let i = 0; i < uint8Array.length; i++) {
                    binary += String.fromCharCode(uint8Array[i]);
                }
                return btoa(binary);
            }

            function base64ToArrayBuffer(base64) {
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            // Implémentation correcte de EVP_BytesToKey d'OpenSSL
            function deriveKeyAndIV(password, salt, keyLength, ivLength) {
                const passwordBytes = new TextEncoder().encode(password);
                const totalLength = keyLength + ivLength;
                const derived = new Uint8Array(totalLength);
                let derivedLength = 0;
                let previousHash = new Uint8Array(0);
                
                while (derivedLength < totalLength) {
                    // Créer le hash MD5
                    const hash = CryptoJS.algo.MD5.create();
                    
                    // Si ce n'est pas le premier round, ajouter le hash précédent
                    if (previousHash.length > 0) {
                        const prevWordArray = CryptoJS.lib.WordArray.create(previousHash);
                        hash.update(prevWordArray);
                    }
                    
                    // Ajouter le password
                    const passwordWordArray = CryptoJS.lib.WordArray.create(passwordBytes);
                    hash.update(passwordWordArray);
                    
                    // Ajouter le salt
                    const saltWordArray = CryptoJS.lib.WordArray.create(salt);
                    hash.update(saltWordArray);
                    
                    const hashResult = hash.finalize();
                    
                    // Convertir le résultat en Uint8Array
                    const hashBytes = new Uint8Array(16); // MD5 = 16 bytes
                    for (let i = 0; i < 16; i++) {
                        hashBytes[i] = (hashResult.words[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff;
                    }
                    
                    // Copier autant que nécessaire dans le résultat final
                    const copyLength = Math.min(hashBytes.length, totalLength - derivedLength);
                    derived.set(hashBytes.slice(0, copyLength), derivedLength);
                    derivedLength += copyLength;
                    
                    // Sauvegarder pour le prochain round
                    previousHash = hashBytes;
                }
                
                console.log('Key derivation - Password length:', passwordBytes.length);
                console.log('Key derivation - Salt:', Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join(''));
                console.log('Key derivation - Key length:', keyLength, 'IV length:', ivLength);
                console.log('Key derivation - Key:', Array.from(derived.slice(0, keyLength)).map(b => b.toString(16).padStart(2, '0')).join(''));
                console.log('Key derivation - IV:', Array.from(derived.slice(keyLength, keyLength + ivLength)).map(b => b.toString(16).padStart(2, '0')).join(''));
                
                return {
                    key: derived.slice(0, keyLength),
                    iv: derived.slice(keyLength, keyLength + ivLength)
                };
            }

            function updatePasswordProgress(message) {
                // Create progress indicator if it doesn't exist
                let $progress = $('#password-progress');
                if ($progress.length === 0) {
                    $progress = $('<div id="password-progress" style="margin-top: 15px; color: rgba(255,255,255,0.8); font-size: 0.9rem; font-style: italic;"></div>');
                    $('#password-form').append($progress);
                }
                $progress.text(message);
            }

            function showPasswordError(message) {
                const $error = $('#password-error');
                $error.text(message).slideDown();
                $('#password-input').focus();
            }

            function hidePasswordError() {
                $('#password-error').slideUp();
            }
            
            // Fonction pour déchiffrer le format JSON
            async function decryptJSONFormat(encryptedData, password) {
                try {
                    const jsonText = new TextDecoder().decode(encryptedData);
                    const data = JSON.parse(jsonText);
                    
                    console.log('JSON parsé, clés:', Object.keys(data));
                    
                    // Décoder les données base64
                    const ciphertext = CryptoJS.enc.Base64.parse(data.ct);
                    const salt = CryptoJS.enc.Base64.parse(data.s);
                    const iv = CryptoJS.enc.Base64.parse(data.iv);
                    
                    console.log('Salt:', salt.toString(CryptoJS.enc.Hex));
                    console.log('IV:', iv.toString(CryptoJS.enc.Hex));
                    
                    // Dériver la clé avec PBKDF2 (comme le script Python)
                    const key = CryptoJS.PBKDF2(password, salt, {
                        keySize: 256/32,  // 32 bytes pour AES-256
                        iterations: 10000
                    });
                    
                    console.log('Clé dérivée:', key.toString(CryptoJS.enc.Hex));
                    
                    // Déchiffrer
                    const decrypted = CryptoJS.AES.decrypt({
                        ciphertext: ciphertext
                    }, key, {
                        iv: iv,
                        mode: CryptoJS.mode.CBC,
                        padding: CryptoJS.pad.Pkcs7
                    });
                    
                    if (!decrypted || decrypted.sigBytes <= 0) {
                        return null;
                    }
                    
                    // Convertir en Uint8Array
                    const hex = decrypted.toString(CryptoJS.enc.Hex);
                    const array = new Uint8Array(hex.length / 2);
                    for (let i = 0; i < hex.length; i += 2) {
                        array[i / 2] = parseInt(hex.substr(i, 2), 16);
                    }
                    
                    return array;
                    
                } catch (error) {
                    console.error('Erreur format JSON:', error);
                    return null;
                }
            }
            
            // Fonction pour déchiffrer le format binaire simple
            async function decryptBinaryFormat(encryptedData, password) {
                try {
                    const data = new Uint8Array(encryptedData);
                    
                    // Détecter le format : simple (32 bytes header) vs sécurisé (80 bytes header)
                    if (data.length < 32) {
                        throw new Error('Fichier trop petit');
                    }
                    
                    const isSecureFormat = data.length > 80 && data.slice(32, 48).some(b => b !== 0);
                    
                    if (isSecureFormat) {
                        console.log('Format sécurisé détecté');
                        return await decryptSecureFormat(data, password);
                    } else {
                        console.log('Format simple détecté');
                        return await decryptSimpleFormat(data, password);
                    }
                    
                } catch (error) {
                    console.error('Erreur format binaire:', error);
                    return null;
                }
            }
            
            // Format simple (compatibilité)
            async function decryptSimpleFormat(data, password) {
                // Extraire salt (16 bytes) + iv (16 bytes) + ciphertext
                const salt = data.slice(0, 16);
                const iv = data.slice(16, 32);
                const ciphertext = data.slice(32);
                
                console.log('Salt:', Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join(''));
                console.log('IV:', Array.from(iv).map(b => b.toString(16).padStart(2, '0')).join(''));
                
                // Convertir en WordArrays CryptoJS
                const saltWA = CryptoJS.lib.WordArray.create(salt);
                const ivWA = CryptoJS.lib.WordArray.create(iv);
                const ciphertextWA = CryptoJS.lib.WordArray.create(ciphertext);
                
                // Dériver la clé avec PBKDF2
                const key = CryptoJS.PBKDF2(password, saltWA, {
                    keySize: 256/32,  // 32 bytes pour AES-256
                    iterations: 10000
                });
                
                console.log('Clé dérivée:', key.toString(CryptoJS.enc.Hex));
                
                // Déchiffrer
                const decrypted = CryptoJS.AES.decrypt({
                    ciphertext: ciphertextWA
                }, key, {
                    iv: ivWA,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                
                if (!decrypted || decrypted.sigBytes <= 0) {
                    return null;
                }
                
                // Convertir en Uint8Array
                const hex = decrypted.toString(CryptoJS.enc.Hex);
                const array = new Uint8Array(hex.length / 2);
                for (let i = 0; i < hex.length; i += 2) {
                    array[i / 2] = parseInt(hex.substr(i, 2), 16);
                }
                
                return array;
            }
            
            // Format sécurisé avec authentification
            async function decryptSecureFormat(data, password) {
                try {
                    // Format: salt(32) + iv(16) + auth_tag(32) + ciphertext
                    const salt = data.slice(0, 32);
                    const iv = data.slice(32, 48);
                    const auth_tag = data.slice(48, 80);
                    const ciphertext = data.slice(80);
                    
                    console.log('🔒 Format sécurisé');
                    console.log('Salt (32B):', Array.from(salt.slice(0, 8)).map(b => b.toString(16).padStart(2, '0')).join('') + '...');
                    console.log('IV (16B):', Array.from(iv).map(b => b.toString(16).padStart(2, '0')).join(''));
                    console.log('Auth tag (32B):', Array.from(auth_tag.slice(0, 8)).map(b => b.toString(16).padStart(2, '0')).join('') + '...');
                    
                    updatePasswordProgress('Dérivation sécurisée de la clé (100k itérations)...');
                    
                    // Dériver les clés avec 100k itérations
                    const saltWA = CryptoJS.lib.WordArray.create(salt);
                    const keyMaterial = CryptoJS.PBKDF2(password, saltWA, {
                        keySize: 512/32,  // 64 bytes total
                        iterations: 100000,
                        hasher: CryptoJS.algo.SHA256
                    });
                    
                    // Séparer clé de chiffrement et clé d'authentification
                    const keyHex = keyMaterial.toString(CryptoJS.enc.Hex);
                    const encryptionKey = CryptoJS.enc.Hex.parse(keyHex.substring(0, 64));  // 32 bytes
                    const authKey = CryptoJS.enc.Hex.parse(keyHex.substring(64));          // 32 bytes
                    
                    console.log('🗝️  Clés dérivées (chiffrement + auth)');
                    
                    updatePasswordProgress('Vérification de l\'intégrité...');
                    
                    // Vérifier l'authentification HMAC
                    // IMPORTANT: MAC sur salt + iv + ciphertext (pas le auth_tag!)
                    const macDataArray = new Uint8Array(salt.length + iv.length + ciphertext.length);
                    macDataArray.set(salt, 0);
                    macDataArray.set(iv, salt.length);
                    macDataArray.set(ciphertext, salt.length + iv.length);
                    
                    const macData = CryptoJS.lib.WordArray.create(macDataArray);
                    const computedTag = CryptoJS.HmacSHA256(macData, authKey);
                    
                    console.log('Auth key:', authKey.toString(CryptoJS.enc.Hex));
                    console.log('MAC data length:', macDataArray.length);
                    console.log('Computed HMAC:', computedTag.toString(CryptoJS.enc.Hex));
                    console.log('Expected HMAC:', Array.from(auth_tag).map(b => b.toString(16).padStart(2, '0')).join(''));
                    
                    const expectedTag = CryptoJS.lib.WordArray.create(auth_tag);
                    const match = computedTag.toString(CryptoJS.enc.Hex) === Array.from(auth_tag).map(b => b.toString(16).padStart(2, '0')).join('');
                    
                    if (!match) {
                        throw new Error('Échec de vérification d\'intégrité - fichier corrompu ou mot de passe incorrect');
                    }
                    
                    console.log('✅ Intégrité vérifiée');
                    updatePasswordProgress('Déchiffrement des données...');
                    
                    // Déchiffrer
                    const ivWA = CryptoJS.lib.WordArray.create(iv);
                    const ciphertextWA = CryptoJS.lib.WordArray.create(ciphertext);
                    
                    const decrypted = CryptoJS.AES.decrypt({
                        ciphertext: ciphertextWA
                    }, encryptionKey, {
                        iv: ivWA,
                        mode: CryptoJS.mode.CBC,
                        padding: CryptoJS.pad.Pkcs7
                    });
                    
                    if (!decrypted || decrypted.sigBytes <= 0) {
                        throw new Error('Échec du déchiffrement');
                    }
                    
                    // Convertir en Uint8Array
                    const hex = decrypted.toString(CryptoJS.enc.Hex);
                    const array = new Uint8Array(hex.length / 2);
                    for (let i = 0; i < hex.length; i += 2) {
                        array[i / 2] = parseInt(hex.substr(i, 2), 16);
                    }
                    
                    console.log('🎉 Déchiffrement sécurisé réussi');
                    
                    return array;
                    
                } catch (error) {
                    console.error('Erreur format sécurisé:', error);
                    throw error;
                }
            }
            
            // Initialize application (called after successful unlock)
            function initializeApp() {
                if (!app.isUnlocked || !app.genData) {
                    return;
                }
                
                // Show loading overlay
                showLoadingOverlay();
                
                // Build search index with progress tracking
                setTimeout(() => {
                    buildSearchIndex(() => {
                        updateStatistics();
                        setupEventHandlers();
                        hideLoadingOverlay();
                        console.log('Genome Explorer ready!');
                    });
                }, 100);
            }

            function showLoadingOverlay() {
                $('#loading-overlay').fadeIn(300);
                $('#loading-message').text('Construction de l\'index de recherche...');
                updateProgress(0);
            }

            function hideLoadingOverlay() {
                $('#loading-overlay').fadeOut(300);
            }

            function updateProgress(percentage, processed, total) {
                const percent = Math.round(percentage);
                $('#progress-bar').css('width', percent + '%');
                $('#progress-text').text(percent + '%');
                
                if (processed !== undefined && total !== undefined) {
                    $('#variants-processed').text(processed.toLocaleString());
                    $('#variants-total').text(total.toLocaleString());
                }
            }

            function buildSearchIndex(callback) {
                console.log('Construction de l\'index de recherche...');
                const startTime = Date.now();
                const totalVariants = app.genData.data.length;
                const batchSize = 10000; // Traiter par lots pour ne pas bloquer l'UI
                let currentIndex = 0;
                
                function processBatch() {
                    const batchEnd = Math.min(currentIndex + batchSize, totalVariants);
                    
                    for (let i = currentIndex; i < batchEnd; i++) {
                        const variant = app.genData.data[i];
                        const parsed = app.genData.parseVariant(variant);
                        
                        if (parsed.type === 'rsid') {
                            app.searchIndex.rsid.set(parsed.rsidDecimal, {
                                index: i,
                                variant,
                                parsed
                            });
                        } else {
                            const key = `${parsed.chromosomeDecimal}-${parsed.positionDecimal}`;
                            if (!app.searchIndex.position.has(key)) {
                                app.searchIndex.position.set(key, []);
                            }
                            app.searchIndex.position.get(key).push({
                                index: i,
                                variant,
                                parsed
                            });
                        }
                    }
                    
                    currentIndex = batchEnd;
                    
                    // Mettre à jour la progression
                    const percentage = (currentIndex / totalVariants) * 100;
                    updateProgress(percentage, currentIndex, totalVariants);
                    
                    // Mettre à jour le message selon la progression
                    if (percentage < 25) {
                        $('#loading-message').text('Analyse des variants RS ID...');
                    } else if (percentage < 50) {
                        $('#loading-message').text('Indexation des positions chromosomiques...');
                    } else if (percentage < 75) {
                        $('#loading-message').text('Organisation des données génomiques...');
                    } else {
                        $('#loading-message').text('Finalisation de l\'index...');
                    }
                    
                    if (currentIndex < totalVariants) {
                        // Continuer avec le prochain lot
                        requestAnimationFrame(processBatch);
                    } else {
                        // Terminé
                        const endTime = Date.now();
                        console.log(`Index construit en ${((endTime - startTime) / 1000).toFixed(2)}s`);
                        console.log(`RS IDs: ${app.searchIndex.rsid.size.toLocaleString()}`);
                        console.log(`Positions: ${app.searchIndex.position.size.toLocaleString()}`);
                        
                        $('#loading-message').text('Index construit avec succès!');
                        updateProgress(100, totalVariants, totalVariants);
                        
                        // Appeler le callback après un court délai pour voir le 100%
                        setTimeout(() => {
                            if (callback) callback();
                        }, 500);
                    }
                }
                
                // Démarrer le traitement
                processBatch();
            }

            function updateStatistics() {
                $('#rsid-count').text(app.searchIndex.rsid.size.toLocaleString());
                $('#position-count').text(app.searchIndex.position.size.toLocaleString());
                $('#total-variants').text(app.genData.metadata.totalVariants.toLocaleString());
            }

            function setupEventHandlers() {
                // Tab switching
                $('.search-tab').click(function() {
                    const tabId = $(this).data('tab');
                    switchTab(tabId);
                });

                // SNP search
                $('#snp-form').submit(function(e) {
                    e.preventDefault();
                    const rsId = parseInt($('#snp-input').val().trim());
                    if (rsId && rsId > 0) {
                        searchBySNP(rsId);
                    }
                });

                // Position search
                $('#position-form').submit(function(e) {
                    e.preventDefault();
                    const chromosome = $('#chromosome-select').val();
                    const position = parseInt($('#position-input').val().trim());
                    if (chromosome && position && position > 0) {
                        searchByPosition(chromosome, position);
                    }
                });

                // Disease search
                $('#disease-form').submit(function(e) {
                    e.preventDefault();
                    const disease = $('#disease-input').val().trim();
                    const minScore = parseFloat($('#min-score-input').val()) || 0;
                    if (disease) {
                        searchByDisease(disease, minScore);
                    }
                });

                // Clear results
                $('#clear-btn').click(clearResults);

                // Copy results as Markdown
                $('#copy-btn').click(copyResultsAsMarkdown);

                // Real-time input validation
                $('#snp-input').on('input', function() {
                    const value = $(this).val();
                    const isValid = value && parseInt(value) > 0;
                    $('#snp-form .search-btn').prop('disabled', !isValid);
                });

                $('#chromosome-select, #position-input').on('input change', function() {
                    const chromosome = $('#chromosome-select').val();
                    const position = parseInt($('#position-input').val());
                    const isValid = chromosome && position > 0;
                    $('#position-form .search-btn').prop('disabled', !isValid);
                });

                $('#disease-input, #min-score-input').on('input', function() {
                    const disease = $('#disease-input').val().trim();
                    const minScore = $('#min-score-input').val();
                    const isValid = disease && minScore !== '';
                    $('#disease-form .search-btn').prop('disabled', !isValid);
                });
            }

            function switchTab(tabId) {
                $('.search-tab').removeClass('active');
                $(`.search-tab[data-tab="${tabId}"]`).addClass('active');
                
                $('.search-form').removeClass('active');
                $(`#${tabId}-form`).addClass('active');
                
                clearResults();
            }

            function searchBySNP(rsId) {
                if (app.isLoading) return;
                
                setLoading(true);
                showLoadingState(`Recherche du SNP rs${rsId}...`);
                
                setTimeout(() => {
                    const result = app.searchIndex.rsid.get(rsId);
                    if (result) {
                        displayResults([result], `SNP rs${rsId}`);
                    } else {
                        showEmptyState(`Aucun variant trouvé pour rs${rsId}`);
                    }
                    setLoading(false);
                }, 300);
            }

            function searchByPosition(chromosome, position) {
                if (app.isLoading) return;
                
                setLoading(true);
                const chromosomeNum = chromosome === 'X' ? 23 : 
                                    chromosome === 'Y' ? 24 : 
                                    chromosome === 'M' ? 25 : 
                                    parseInt(chromosome);
                
                showLoadingState(`Recherche sur chr${chromosome}:${position}...`);
                
                setTimeout(() => {
                    const key = `${chromosomeNum}-${position}`;
                    const results = app.searchIndex.position.get(key);
                    
                    if (results && results.length > 0) {
                        displayResults(results, `Chromosome ${chromosome}, position ${position}`);
                    } else {
                        showEmptyState(`Aucun variant trouvé pour chr${chromosome}:${position}`);
                    }
                    setLoading(false);
                }, 300);
            }

            async function searchByDisease(disease, minScore = 10) {
                if (app.isLoading) return;
                
                setLoading(true);
                showLoadingState(`Recherche de variants associés à "${disease}" (score ≥ ${minScore})...`);
                
                try {
                    // Encoder le nom de la maladie pour l'URL
                    const encodedDisease = encodeURIComponent(disease);
                    
                    // Récupérer tous les variants par pagination
                    const allHits = [];
                    let from = 0;
                    const batchSize = 1000; // Taille maximale par requête
                    let total = 0;
                    
                    do {
                        showLoadingState(`Récupération des variants ${from + 1}-${from + batchSize} (score ≥ ${minScore})...`);
                        
                        const apiUrl = `https://myvariant.info/v1/query?q=clinvar.rcv.conditions.name:"${encodedDisease}"&fields=_id,dbsnp.rsid,clinvar.rcv.conditions.name&size=${batchSize}&from=${from}&min_score=${minScore}`;
                        
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`Erreur API: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (from === 0) {
                            total = data.total;
                            console.log(`Total de ${total} variants trouvés pour "${disease}" avec score ≥ ${minScore}`);
                        }
                        
                        if (data.hits && data.hits.length > 0) {
                            allHits.push(...data.hits);
                            from += data.hits.length;
                            
                            // Si on a récupéré moins que batchSize, c'est qu'on a tout
                            if (data.hits.length < batchSize) {
                                break;
                            }
                        } else {
                            break;
                        }
                        
                        // Éviter de faire trop de requêtes trop rapidement
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } while (from < total);
                    
                    console.log(`Récupéré ${allHits.length} variants au total avec score ≥ ${minScore}`);
                    
                    if (allHits.length > 0) {
                        showLoadingState(`Analyse de ${allHits.length} variants...`);
                        displayDiseaseResults(allHits, disease, total, minScore);
                    } else {
                        showEmptyState(`Aucun variant trouvé pour la maladie "${disease}" avec un score ≥ ${minScore}`);
                    }
                    
                } catch (error) {
                    console.error('Erreur recherche maladie:', error);
                    showEmptyState(`Erreur lors de la recherche: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            }

            function displayDiseaseResults(hits, disease, total, minScore = 10) {
                // Filtrer pour ne garder que les variants présents dans le génome ET avec mutations correspondantes
                const matchingVariants = [];
                
                hits.forEach((hit) => {
                    const rsid = hit.dbsnp?.rsid;
                    
                    if (rsid) {
                        // Extraire le numéro RS (enlever le préfixe "rs")
                        const rsNumber = parseInt(rsid.replace('rs', ''));
                        
                        if (rsNumber && app.searchIndex.rsid.has(rsNumber)) {
                            const localVariant = app.searchIndex.rsid.get(rsNumber);
                            
                            // Extraire les mutations pour comparaison
                            const clinvarMutation = extractMutationFromId(hit._id);
                            let genomeMutation = null;
                            
                            if (localVariant && localVariant.parsed && localVariant.parsed.mutation) {
                                const mut = localVariant.parsed.mutation;
                                if (mut.type === 'substitution') {
                                    genomeMutation = `${mut.ref}>${mut.alt}`;
                                } else if (mut.type === 'complex') {
                                    genomeMutation = mut.sequence;
                                }
                            }
                            
                            // Ne garder que si les mutations correspondent
                            if (clinvarMutation && genomeMutation && clinvarMutation === genomeMutation) {
                                matchingVariants.push({
                                    hit: hit,
                                    rsNumber: rsNumber,
                                    localVariant: localVariant,
                                    clinvarMutation: clinvarMutation,
                                    genomeMutation: genomeMutation
                                });
                            }
                        }
                    }
                });
                
                app.currentResults = matchingVariants; // Stocker pour l'export
                
                // Créer le résumé
                let html = `
                    <div class="disease-summary">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h3><i class="fas fa-disease"></i> ${disease}</h3>
                                <p><strong>${matchingVariants.length}</strong> variants avec mutations correspondantes sur <strong>${hits.length}</strong> analysés (total ClinVar ≥ ${minScore}: <strong>${total}</strong>)</p>
                            </div>
                            ${matchingVariants.length > 1 ? `
                                <button class="disease-link" id="load-all-clinvar" onclick="loadAllClinVar('${disease.replace(/'/g, "\\'")}'); return false;">
                                    <i class="fas fa-expand-arrows-alt"></i> Afficher tous les ClinVar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                if (matchingVariants.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-dna"></i>
                            </div>
                            <h3>Aucune mutation correspondante trouvée</h3>
                            <p>Parmi les ${hits.length} variants analysés pour "${disease}", aucun ne correspond exactement aux mutations de votre génome.</p>
                        </div>
                    `;
                } else {
                    // Afficher chaque variant avec mutation correspondante
                    matchingVariants.forEach(({hit, rsNumber, localVariant, clinvarMutation, genomeMutation}) => {
                        const rsid = hit.dbsnp?.rsid;
                        const chromosome = extractChromosomeFromId(hit._id);
                        const position = extractPositionFromId(hit._id);
                        
                        html += `
                            <div class="disease-result">
                                <div class="disease-result-header">
                                    <div>
                                        <span class="disease-rsid">${rsid}</span>
                                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px; flex-wrap: wrap;">
                                            <span class="disease-mutation">ClinVar: ${clinvarMutation}</span>
                                            <span class="disease-mutation" style="background: rgba(76, 175, 80, 0.3);">Génome: ${genomeMutation}</span>
                                            <span class="mutation-match match">✓</span>
                                        </div>
                                    </div>
                                    <span class="disease-status status-present">
                                        ✓ Mutations correspondantes
                                    </span>
                                </div>
                                <div class="disease-details">
                                    <div class="detail-item">
                                        <div class="detail-label">Chromosome</div>
                                        <div class="detail-value">${chromosome}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Position</div>
                                        <div class="detail-value">${position || 'Non spécifiée'}</div>
                                    </div>
                                    ${hit._score ? `
                                    <div class="detail-item">
                                        <div class="detail-label">Score de pertinence</div>
                                        <div class="detail-value">${hit._score.toFixed(2)}</div>
                                    </div>
                                    ` : ''}
                                </div>
                                <button class="disease-link" onclick="toggleClinVarInList(${rsNumber}, this); return false;">
                                    <i class="fas fa-dna"></i> Voir ClinVar
                                </button>
                                <div class="clinvar-result" id="disease-clinvar-${rsNumber}" style="display: none; margin-top: 15px;"></div>
                            </div>
                        `;
                    });
                }
                
                $('#results-count').text(`${matchingVariants.length} variants avec mutations correspondantes pour: ${disease}`);
                $('#results-container').html(html);
                $('#results').show();
                
                // Smooth scroll to results
                $('html, body').animate({
                    scrollTop: $('#results').offset().top - 20
                }, 500);
            }

            function extractMutationFromId(id) {
                if (!id) return null;
                const match = id.match(/([ATCG]+)[>]([ATCG]+)/);
                if (match) {
                    return `${match[1]}>${match[2]}`;
                }
                return null;
            }

            function extractChromosomeFromId(id) {
                if (!id) return 'Non spécifié';
                const match = id.match(/chr([0-9XYM]+):/);
                if (match) {
                    return `chr${match[1]}`;
                }
                return 'Non spécifié';
            }

            function extractPositionFromId(id) {
                if (!id) return null;
                const match = id.match(/g\.(\d+)/);
                if (match) {
                    return parseInt(match[1]);
                }
                return null;
            }

            // Fonction pour afficher/masquer ClinVar dans la liste des maladies
            window.toggleClinVarInList = async function(rsId, buttonElement) {
                const $button = $(buttonElement);
                const $clinvarResult = $(`#disease-clinvar-${rsId}`);
                
                // Si les données sont déjà affichées, les masquer
                if ($clinvarResult.is(':visible')) {
                    $clinvarResult.slideUp();
                    $button.html('<i class="fas fa-dna"></i> Voir ClinVar');
                    return;
                }
                
                // État de chargement
                $button.addClass('loading').prop('disabled', true);
                $button.html('<i class="fas fa-dna"></i> Chargement...');
                
                try {
                    // Essayer d'abord avec le RS ID direct
                    let response = await fetch(`https://myvariant.info/v1/variant/rs${rsId}?fields=clinvar`);
                    let data = null;
                    
                    if (response.ok) {
                        data = await response.json();
                    }
                    
                    // Si pas de données ou pas de ClinVar, essayer une recherche alternative
                    if (!data || !data.clinvar) {
                        // Essayer avec une requête de recherche
                        response = await fetch(`https://myvariant.info/v1/query?q=dbsnp.rsid:rs${rsId}&fields=clinvar,_id`);
                        if (response.ok) {
                            const searchData = await response.json();
                            if (searchData.hits && searchData.hits.length > 0) {
                                data = searchData.hits[0];
                            }
                        }
                    }
                    
                    if (data) {
                        displayClinVarInList(rsId, data, $clinvarResult);
                    } else {
                        throw new Error('Aucune donnée trouvée');
                    }
                    
                } catch (error) {
                    console.error('Erreur ClinVar:', error);
                    $clinvarResult.html(`
                        <div class="clinvar-empty">
                            <i class="fas fa-info-circle"></i>
                            Aucune donnée ClinVar disponible pour rs${rsId}.
                        </div>
                    `);
                    $clinvarResult.slideDown();
                } finally {
                    $button.removeClass('loading').prop('disabled', false);
                    $button.html('<i class="fas fa-dna"></i> Masquer ClinVar');
                }
            };

            function displayClinVarInList(rsId, data, $container) {
                // Extraire la mutation du _id (ex: "chr19:g.45411941T>C" -> "T>C")
                let mutation = 'Non spécifiée';
                if (data._id) {
                    // Chercher différents patterns de mutation
                    const patterns = [
                        /([ATCG])>([ATCG])/,  // Simple substitution
                        /([ATCG]+)>([ATCG]+)/, // Substitution multiple
                        /del([ATCG]+)/,        // Délétion
                        /ins([ATCG]+)/,        // Insertion
                        /dup([ATCG]+)/         // Duplication
                    ];
                    
                    for (const pattern of patterns) {
                        const match = data._id.match(pattern);
                        if (match) {
                            if (pattern.source.includes('del')) {
                                mutation = `del${match[1]}`;
                            } else if (pattern.source.includes('ins')) {
                                mutation = `ins${match[1]}`;
                            } else if (pattern.source.includes('dup')) {
                                mutation = `dup${match[1]}`;
                            } else {
                                mutation = `${match[1]}>${match[2]}`;
                            }
                            break;
                        }
                    }
                }
                
                let html = `
                    <div class="clinvar-header">
                        <h4><i class="fas fa-dna"></i> ClinVar - rs${rsId}</h4>
                        ${mutation !== 'Non spécifiée' ? `<span class="clinvar-mutation">${mutation}</span>` : ''}
                    </div>
                `;
                
                // Vérifier si ClinVar existe et contient des données
                if (data.clinvar) {
                    const conditions = new Set();
                    
                    // Gérer différentes structures de données ClinVar
                    if (data.clinvar.rcv) {
                        // Structure avec RCV array
                        const rcvArray = Array.isArray(data.clinvar.rcv) ? data.clinvar.rcv : [data.clinvar.rcv];
                        rcvArray.forEach(rcv => {
                            if (rcv.conditions) {
                                if (rcv.conditions.name) {
                                    conditions.add(rcv.conditions.name);
                                } else if (Array.isArray(rcv.conditions)) {
                                    rcv.conditions.forEach(cond => {
                                        if (cond.name) conditions.add(cond.name);
                                    });
                                }
                            }
                        });
                    }
                    
                    // Gérer la structure alternative avec clinical_significance
                    if (data.clinvar.clinical_significance) {
                        html += `
                            <div style="color: white; margin: 10px 0;">
                                <strong>Signification clinique:</strong> ${data.clinvar.clinical_significance}
                            </div>
                        `;
                    }
                    
                    // Afficher les conditions si trouvées
                    const validConditions = Array.from(conditions).filter(c => 
                        c && c !== 'not provided' && c !== 'not specified'
                    );
                    
                    if (validConditions.length > 0) {
                        html += `
                            <div class="clinvar-conditions">
                                <h5 style="color: white; margin: 10px 0; font-size: 1rem;">
                                    Conditions associées (${validConditions.length}):
                                </h5>
                        `;
                        
                        // Trier les conditions alphabétiquement
                        validConditions.sort().forEach(condition => {
                            html += `<div class="clinvar-condition">${condition}</div>`;
                        });
                        
                        html += '</div>';
                    } else if (!data.clinvar.clinical_significance) {
                        html += `
                            <div class="clinvar-empty">
                                <i class="fas fa-info-circle"></i>
                                Données ClinVar présentes mais aucune condition spécifique listée.
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div class="clinvar-empty">
                            <i class="fas fa-info-circle"></i>
                            Aucune donnée ClinVar disponible pour rs${rsId}.
                        </div>
                    `;
                }
                
                $container.html(html);
                $container.slideDown();
            }

            // Fonction pour charger tous les ClinVar d'une recherche par maladie
            window.loadAllClinVar = async function(disease) {
                const $button = $('#load-all-clinvar');
                const originalText = $button.html();
                
                // Si tous sont déjà chargés, les fermer
                const allClinvarContainers = $('[id^="disease-clinvar-"]');
                const visibleContainers = allClinvarContainers.filter(':visible');
                
                if (visibleContainers.length > 0) {
                    // Fermer tous les ClinVar
                    visibleContainers.slideUp();
                    // Remettre les boutons à "Voir ClinVar"
                    $('button[onclick*="toggleClinVarInList"]').html('<i class="fas fa-dna"></i> Voir ClinVar');
                    $button.html('<i class="fas fa-expand-arrows-alt"></i> Afficher tous les ClinVar');
                    return;
                }
                
                // Chargement de tous les ClinVar
                $button.addClass('loading').prop('disabled', true);
                $button.html('<i class="fas fa-dna"></i> Chargement de tous les ClinVar...');
                
                try {
                    // Récupérer tous les RS IDs visibles
                    const rsIds = [];
                    $('button[onclick*="toggleClinVarInList"]').each(function() {
                        const onclick = $(this).attr('onclick');
                        const match = onclick.match(/toggleClinVarInList\((\d+),/);
                        if (match) {
                            rsIds.push(parseInt(match[1]));
                        }
                    });
                    
                    console.log(`Chargement de ${rsIds.length} variants ClinVar...`);
                    
                    // Charger en parallèle avec limitation de concurrence
                    const batchSize = 5; // Charger 5 à la fois
                    
                    for (let i = 0; i < rsIds.length; i += batchSize) {
                        const batch = rsIds.slice(i, i + batchSize);
                        $button.html(`<i class="fas fa-dna"></i> Chargement ${i + 1}-${Math.min(i + batchSize, rsIds.length)}/${rsIds.length}...`);
                        
                        // Lancer les requêtes en parallèle pour ce lot
                        const promises = batch.map(rsId => loadClinVarDataForList(rsId));
                        await Promise.allSettled(promises);
                        
                        // Petite pause entre les lots
                        if (i + batchSize < rsIds.length) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }
                    
                    // Afficher tous les résultats
                    rsIds.forEach(rsId => {
                        const $container = $(`#disease-clinvar-${rsId}`);
                        if ($container.html().trim() !== '') {
                            $container.slideDown();
                        }
                    });
                    
                    // Mettre à jour tous les boutons
                    $('button[onclick*="toggleClinVarInList"]').html('<i class="fas fa-dna"></i> Masquer ClinVar');
                    
                    $button.html('<i class="fas fa-compress-arrows-alt"></i> Masquer tous les ClinVar');
                    
                } catch (error) {
                    console.error('Erreur lors du chargement de tous les ClinVar:', error);
                    $button.html(originalText);
                } finally {
                    $button.removeClass('loading').prop('disabled', false);
                }
            };

            // Fonction helper pour charger ClinVar sans interface (pour loadAllClinVar)
            async function loadClinVarDataForList(rsId) {
                const $clinvarResult = $(`#disease-clinvar-${rsId}`);
                
                // Si déjà chargé, ignorer
                if ($clinvarResult.html().trim() !== '') {
                    return;
                }
                
                try {
                    // Essayer d'abord avec le RS ID direct
                    let response = await fetch(`https://myvariant.info/v1/variant/rs${rsId}?fields=clinvar`);
                    let data = null;
                    
                    if (response.ok) {
                        data = await response.json();
                    }
                    
                    // Si pas de données ou pas de ClinVar, essayer une recherche alternative
                    if (!data || !data.clinvar) {
                        // Essayer avec une requête de recherche
                        response = await fetch(`https://myvariant.info/v1/query?q=dbsnp.rsid:rs${rsId}&fields=clinvar,_id`);
                        if (response.ok) {
                            const searchData = await response.json();
                            if (searchData.hits && searchData.hits.length > 0) {
                                data = searchData.hits[0];
                            }
                        }
                    }
                    
                    if (data) {
                        displayClinVarInList(rsId, data, $clinvarResult);
                    } else {
                        $clinvarResult.html(`
                            <div class="clinvar-empty">
                                <i class="fas fa-info-circle"></i>
                                Aucune donnée ClinVar disponible pour rs${rsId}.
                            </div>
                        `);
                    }
                    
                } catch (error) {
                    console.error(`Erreur ClinVar pour rs${rsId}:`, error);
                    $clinvarResult.html(`
                        <div class="clinvar-empty">
                            <i class="fas fa-info-circle"></i>
                            Erreur lors du chargement pour rs${rsId}.
                        </div>
                    `);
                }
            }

            // Fonction pour afficher les détails d'un variant depuis la recherche par maladie
            window.showVariantDetails = function(rsNumber) {
                const result = app.searchIndex.rsid.get(rsNumber);
                if (result) {
                    // Afficher le variant
                    displayResults([result], `SNP rs${rsNumber}`);
                    
                    // Charger automatiquement les données ClinVar après un court délai
                    setTimeout(() => {
                        const button = document.querySelector(`button[onclick*="loadClinVarData(${rsNumber}"]`);
                        if (button) {
                            loadClinVarData(rsNumber, button);
                        }
                    }, 500);
                }
            };

            function displayResults(results, searchInfo) {
                app.currentResults = results;
                
                const resultsHtml = results.map((result, index) => {
                    const parsed = result.parsed;
                    const isRsid = parsed.type === 'rsid';
                    
                    // Build details HTML
                    let detailsHtml = '';
                    if (isRsid) {
                        detailsHtml = `
                            <div class="detail-item">
                                <div class="detail-label">RS ID</div>
                                <div class="detail-value">rs${parsed.rsidDecimal}</div>
                                <button class="clinvar-btn" onclick="loadClinVarData(${parsed.rsidDecimal}, this)">
                                    <i class="fas fa-dna"></i> ClinVar
                                </button>
                            </div>
                        `;
                    } else {
                        const chrName = parsed.chromosomeDecimal === 23 ? 'X' : 
                                      parsed.chromosomeDecimal === 24 ? 'Y' : 
                                      parsed.chromosomeDecimal === 25 ? 'M' : 
                                      parsed.chromosomeDecimal;
                        
                        detailsHtml = `
                            <div class="detail-item">
                                <div class="detail-label">Chromosome</div>
                                <div class="detail-value">chr${chrName}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Position</div>
                                <div class="detail-value">${parsed.positionDecimal}</div>
                            </div>
                        `;
                    }
                    
                    // Mutation display
                    let mutationHtml = '';
                    if (parsed.mutation && parsed.mutation.type === 'substitution') {
                        mutationHtml = `
                            <div class="detail-item">
                                <div class="detail-label">Mutation</div>
                                <div class="detail-value">
                                    <div class="mutation-display">
                                        ${parsed.mutation.ref} → ${parsed.mutation.alt}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (parsed.mutation && parsed.mutation.type === 'complex') {
                        mutationHtml = `
                            <div class="detail-item">
                                <div class="detail-label">Séquence</div>
                                <div class="detail-value">
                                    <div class="mutation-display mutation-complex">
                                        ${parsed.mutation.sequence}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="result-item">
                            <div class="result-header">
                                <div class="result-title">Variant #${result.index + 1}</div>
                                <div class="result-badge ${isRsid ? 'badge-rsid' : 'badge-position'}">
                                    ${isRsid ? 'RS ID' : 'Position'}
                                </div>
                            </div>
                            <div class="result-details">
                                ${detailsHtml}
                                ${mutationHtml}
                            </div>
                            ${isRsid ? '<div class="clinvar-result" id="clinvar-' + parsed.rsidDecimal + '"></div>' : ''}
                        </div>
                    `;
                }).join('');
                
                $('#results-count').text(`${results.length} résultat${results.length > 1 ? 's' : ''} pour: ${searchInfo}`);
                $('#results-container').html(resultsHtml);
                $('#results').show();
                
                // Smooth scroll to results
                $('html, body').animate({
                    scrollTop: $('#results').offset().top - 20
                }, 500);
            }

            function showLoadingState(message) {
                $('#results-container').html(`
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <h3>${message}</h3>
                    </div>
                `);
                $('#results').show();
            }

            function showEmptyState(message) {
                $('#results-container').html(`
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>Aucun résultat trouvé</h3>
                        <p>${message}</p>
                    </div>
                `);
                $('#results-count').text('0 résultat');
                $('#results').show();
            }

            function setLoading(loading) {
                app.isLoading = loading;
                $('.search-btn').prop('disabled', loading);
                
                if (loading) {
                    $('.search-btn').addClass('loading').text('');
                } else {
                    $('.search-btn').removeClass('loading');
                    $('#snp-form .search-btn').html('<i class="fas fa-dna"></i> Rechercher SNP');
                    $('#position-form .search-btn').html('<i class="fas fa-location-arrow"></i> Rechercher Position');
                    $('#disease-form .search-btn').html('<i class="fas fa-search-plus"></i> Rechercher Maladie');
                }
            }

            function clearResults() {
                $('#results').hide();
                $('#snp-input').val('');
                $('#chromosome-select').val('');
                $('#position-input').val('');
                $('#disease-input').val('');
                $('#min-score-input').val('10');
                $('.search-btn').prop('disabled', true);
                app.currentResults = [];
            }

            async function copyResultsAsMarkdown() {
                if (app.currentResults.length === 0) {
                    alert('Aucun résultat à copier');
                    return;
                }
                
                // Détecter le type de recherche basé sur la structure des données
                const isDiseaseCategoriaSearch = app.currentResults[0] && app.currentResults[0].hit;
                
                // Créer le contenu Markdown
                let markdown = '# Résultats de recherche génomique\n\n';
                markdown += `**Date**: ${new Date().toLocaleDateString('fr-FR')}\n`;
                
                if (isDiseaseCategoriaSearch) {
                    // Recherche par maladie - récupérer le nom de la maladie depuis l'interface
                    const diseaseTitle = $('.disease-summary h3').text().replace('🧬 ', '').trim();
                    const diseaseSummary = $('.disease-summary p').first().text();
                    
                    markdown += `**Type de recherche**: Recherche par maladie\n`;
                    markdown += `**Maladie**: ${diseaseTitle}\n`;
                    markdown += `**${diseaseSummary}**\n\n`;
                    markdown += '---\n\n';
                    
                    // Traiter chaque variant de la recherche par maladie
                    for (const resultItem of app.currentResults) {
                        const { hit, rsNumber } = resultItem;
                        const rsid = hit.dbsnp?.rsid;
                        const mutation = extractMutationFromId(hit._id);
                        const chromosome = extractChromosomeFromId(hit._id);
                        const position = extractPositionFromId(hit._id);
                        
                        markdown += `## ${rsid || 'Variant sans RS ID'}\n\n`;
                        markdown += `**Type**: Variant associé à ${diseaseTitle}\n`;
                        if (rsid) markdown += `**RS ID**: ${rsid}\n`;
                        markdown += `**Chromosome**: ${chromosome}\n`;
                        if (position) markdown += `**Position**: ${position}\n`;
                        if (mutation) markdown += `**Mutation**: ${mutation}\n`;
                        if (hit._score) markdown += `**Score de pertinence**: ${hit._score.toFixed(2)}\n`;
                        
                        // Données ClinVar si disponibles et ouvertes
                        const clinvarDiv = $(`#disease-clinvar-${rsNumber}`);
                        if (clinvarDiv.length && clinvarDiv.is(':visible') && clinvarDiv.html().trim() !== '') {
                            markdown += '\n### Données ClinVar\n\n';
                            
                            // Extraire la mutation ClinVar
                            const mutationElement = clinvarDiv.find('.clinvar-mutation');
                            if (mutationElement.length) {
                                markdown += `**Mutation ClinVar**: ${mutationElement.text()}\n\n`;
                            }
                            
                            // Extraire la signification clinique
                            const clinicalSig = clinvarDiv.find('div:contains("Signification clinique:")');
                            if (clinicalSig.length) {
                                const sigText = clinicalSig.text().replace('Signification clinique:', '').trim();
                                markdown += `**Signification clinique**: ${sigText}\n\n`;
                            }
                            
                            // Extraire les conditions
                            const conditions = clinvarDiv.find('.clinvar-condition');
                            if (conditions.length > 0) {
                                markdown += '**Conditions associées**:\n';
                                conditions.each(function() {
                                    markdown += `- ${$(this).text()}\n`;
                                });
                                markdown += '\n';
                            } else {
                                const emptyMsg = clinvarDiv.find('.clinvar-empty');
                                if (emptyMsg.length) {
                                    markdown += `*${emptyMsg.text().trim()}*\n\n`;
                                }
                            }
                        } else {
                            markdown += '\n*Données ClinVar non chargées*\n\n';
                        }
                        
                        markdown += '---\n\n';
                    }
                } else {
                    // Recherche classique (SNP ou position)
                    markdown += `**Type de recherche**: Recherche classique\n`;
                    markdown += `**Nombre de résultats**: ${app.currentResults.length}\n\n`;
                    markdown += '---\n\n';
                    
                    for (const result of app.currentResults) {
                        const parsed = result.parsed;
                        
                        // Titre du variant
                        if (parsed.type === 'rsid') {
                            markdown += `## Variant: rs${parsed.rsidDecimal}\n\n`;
                            markdown += `**Type**: SNP (RS ID)\n`;
                            markdown += `**RS ID**: rs${parsed.rsidDecimal}\n`;
                        } else {
                            const chrName = parsed.chromosomeDecimal === 23 ? 'X' : 
                                          parsed.chromosomeDecimal === 24 ? 'Y' : 
                                          parsed.chromosomeDecimal === 25 ? 'M' : 
                                          parsed.chromosomeDecimal;
                            markdown += `## Variant: chr${chrName}:${parsed.positionDecimal}\n\n`;
                            markdown += `**Type**: Position chromosomique\n`;
                            markdown += `**Chromosome**: ${chrName}\n`;
                            markdown += `**Position**: ${parsed.positionDecimal}\n`;
                        }
                        
                        // Mutation
                        if (parsed.mutation) {
                            if (parsed.mutation.type === 'substitution') {
                                markdown += `**Mutation**: ${parsed.mutation.ref} → ${parsed.mutation.alt}\n`;
                            } else if (parsed.mutation.type === 'complex') {
                                markdown += `**Séquence**: ${parsed.mutation.sequence}\n`;
                            }
                        }
                        
                        // Données ClinVar si disponibles
                        if (parsed.type === 'rsid') {
                            const clinvarDiv = $(`#clinvar-${parsed.rsidDecimal}`);
                            if (clinvarDiv.length && clinvarDiv.is(':visible')) {
                                markdown += '\n### Données ClinVar\n\n';
                                
                                // Extraire la mutation ClinVar
                                const mutationElement = clinvarDiv.find('.clinvar-mutation');
                                if (mutationElement.length) {
                                    markdown += `**Mutation ClinVar**: ${mutationElement.text()}\n\n`;
                                }
                                
                                // Extraire les conditions
                                const conditions = clinvarDiv.find('.clinvar-condition');
                                if (conditions.length > 0) {
                                    markdown += '**Conditions associées**:\n';
                                    conditions.each(function() {
                                        markdown += `- ${$(this).text()}\n`;
                                    });
                                } else {
                                    const emptyMsg = clinvarDiv.find('.clinvar-empty');
                                    if (emptyMsg.length) {
                                        markdown += `*${emptyMsg.text().trim()}*\n`;
                                    }
                                }
                            }
                        }
                        
                        markdown += '\n---\n\n';
                    }
                }
                
                // Copier dans le presse-papiers
                try {
                    await navigator.clipboard.writeText(markdown);
                    
                    // Feedback visuel
                    const $btn = $('#copy-btn');
                    const originalHtml = $btn.html();
                    $btn.html('<i class="fas fa-check"></i> Copié!');
                    $btn.css('background', 'rgba(76, 175, 80, 0.3)');
                    
                    setTimeout(() => {
                        $btn.html(originalHtml);
                        $btn.css('background', '');
                    }, 2000);
                    
                } catch (err) {
                    console.error('Erreur lors de la copie:', err);
                    // Fallback: créer un textarea temporaire
                    const textarea = document.createElement('textarea');
                    textarea.value = markdown;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    
                    try {
                        document.execCommand('copy');
                        const $btn = $('#copy-btn');
                        const originalHtml = $btn.html();
                        $btn.html('<i class="fas fa-check"></i> Copié!');
                        $btn.css('background', 'rgba(76, 175, 80, 0.3)');
                        
                        setTimeout(() => {
                            $btn.html(originalHtml);
                            $btn.css('background', '');
                        }, 2000);
                    } catch (err) {
                        alert('Erreur lors de la copie. Veuillez réessayer.');
                    } finally {
                        document.body.removeChild(textarea);
                    }
                }
            }

            // ClinVar Integration
            window.loadClinVarData = async function(rsId, buttonElement) {
                const $button = $(buttonElement);
                const $clinvarResult = $(`#clinvar-${rsId}`);
                
                // Si les données sont déjà affichées, les masquer
                if ($clinvarResult.is(':visible')) {
                    $clinvarResult.slideUp();
                    $button.html('<i class="fas fa-dna"></i> ClinVar');
                    return;
                }
                
                // État de chargement
                $button.addClass('loading').prop('disabled', true);
                $button.html('<i class="fas fa-dna"></i> Chargement...');
                
                try {
                    // Essayer d'abord avec le RS ID direct
                    let response = await fetch(`https://myvariant.info/v1/variant/rs${rsId}?fields=clinvar`);
                    let data = null;
                    
                    if (response.ok) {
                        data = await response.json();
                    }
                    
                    // Si pas de données ou pas de ClinVar, essayer une recherche alternative
                    if (!data || !data.clinvar) {
                        // Essayer avec une requête de recherche
                        response = await fetch(`https://myvariant.info/v1/query?q=dbsnp.rsid:rs${rsId}&fields=clinvar,_id`);
                        if (response.ok) {
                            const searchData = await response.json();
                            if (searchData.hits && searchData.hits.length > 0) {
                                data = searchData.hits[0];
                            }
                        }
                    }
                    
                    if (data) {
                        displayClinVarResults(rsId, data, $clinvarResult);
                    } else {
                        throw new Error('Aucune donnée trouvée');
                    }
                    
                } catch (error) {
                    console.error('Erreur ClinVar:', error);
                    $clinvarResult.html(`
                        <div class="clinvar-empty">
                            <i class="fas fa-info-circle"></i>
                            Aucune donnée ClinVar disponible pour rs${rsId}.
                        </div>
                    `);
                    $clinvarResult.slideDown();
                } finally {
                    $button.removeClass('loading').prop('disabled', false);
                    $button.html('<i class="fas fa-dna"></i> Masquer ClinVar');
                }
            };

            function displayClinVarResults(rsId, data, $container) {
                // Extraire la mutation du _id (ex: "chr19:g.45411941T>C" -> "T>C")
                let mutation = 'Non spécifiée';
                if (data._id) {
                    // Chercher différents patterns de mutation
                    const patterns = [
                        /([ATCG])>([ATCG])/,  // Simple substitution
                        /([ATCG]+)>([ATCG]+)/, // Substitution multiple
                        /del([ATCG]+)/,        // Délétion
                        /ins([ATCG]+)/,        // Insertion
                        /dup([ATCG]+)/         // Duplication
                    ];
                    
                    for (const pattern of patterns) {
                        const match = data._id.match(pattern);
                        if (match) {
                            if (pattern.source.includes('del')) {
                                mutation = `del${match[1]}`;
                            } else if (pattern.source.includes('ins')) {
                                mutation = `ins${match[1]}`;
                            } else if (pattern.source.includes('dup')) {
                                mutation = `dup${match[1]}`;
                            } else {
                                mutation = `${match[1]}>${match[2]}`;
                            }
                            break;
                        }
                    }
                }
                
                let html = `
                    <div class="clinvar-header">
                        <h4><i class="fas fa-dna"></i> ClinVar - rs${rsId}</h4>
                        ${mutation !== 'Non spécifiée' ? `<span class="clinvar-mutation">${mutation}</span>` : ''}
                    </div>
                `;
                
                // Vérifier si ClinVar existe et contient des données
                if (data.clinvar) {
                    const conditions = new Set();
                    
                    // Gérer différentes structures de données ClinVar
                    if (data.clinvar.rcv) {
                        // Structure avec RCV array
                        const rcvArray = Array.isArray(data.clinvar.rcv) ? data.clinvar.rcv : [data.clinvar.rcv];
                        rcvArray.forEach(rcv => {
                            if (rcv.conditions) {
                                if (rcv.conditions.name) {
                                    conditions.add(rcv.conditions.name);
                                } else if (Array.isArray(rcv.conditions)) {
                                    rcv.conditions.forEach(cond => {
                                        if (cond.name) conditions.add(cond.name);
                                    });
                                }
                            }
                        });
                    }
                    
                    // Gérer la structure alternative avec clinical_significance
                    if (data.clinvar.clinical_significance) {
                        html += `
                            <div style="color: white; margin: 10px 0;">
                                <strong>Signification clinique:</strong> ${data.clinvar.clinical_significance}
                            </div>
                        `;
                    }
                    
                    // Afficher les conditions si trouvées
                    const validConditions = Array.from(conditions).filter(c => 
                        c && c !== 'not provided' && c !== 'not specified'
                    );
                    
                    if (validConditions.length > 0) {
                        html += `
                            <div class="clinvar-conditions">
                                <h5 style="color: white; margin: 10px 0; font-size: 1rem;">
                                    Conditions associées (${validConditions.length}):
                                </h5>
                        `;
                        
                        // Trier les conditions alphabétiquement
                        validConditions.sort().forEach(condition => {
                            html += `<div class="clinvar-condition">${condition}</div>`;
                        });
                        
                        html += '</div>';
                    } else if (!data.clinvar.clinical_significance) {
                        html += `
                            <div class="clinvar-empty">
                                <i class="fas fa-info-circle"></i>
                                Données ClinVar présentes mais aucune condition spécifique listée.
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div class="clinvar-empty">
                            <i class="fas fa-info-circle"></i>
                            Aucune donnée ClinVar disponible pour rs${rsId}.
                        </div>
                    `;
                }
                
                $container.html(html);
                $container.slideDown();
            }

        });
    </script>
</body>
</html>